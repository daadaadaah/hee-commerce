<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Hee-commerce 결제 테스트 페이지</title>
</head>
<body>
<h1>결제 페이지</h1>

<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script>
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    const add3day = String(date.getDate() + 3).padStart(2, "0");

    const encodedRoomId = 'GE======'; // 1 (base32 encoding)

    const reservationParam = {
        reservationCommand: 'KYUNGTAK_RESERVATION',
        guestName: '김커머스',
        guestPhone: '010-2345-6789',
        numberOfGuests: 3,
        checkDate: {
            checkInDate: year + '-' + month + '-' + day,
            checkOutDate: year + '-' + month + '-' + add3day
        },
        paymentType: 'KAKAO_PAY'
    };

    const price = 20000;


    IMP.init('imp86503506');

    /* 2. 결제 데이터 정의하기 */
    const data = {
        pg: 'html5_inicis',                           // PG사
        pay_method: 'card',                           // 결제수단
        merchant_uid: `491211134`,  // 주문번호
        amount: 100,                                 // 결제금액
        name: '아임포트 결제 테스트',                   // 주문명
        buyer_name: '홍길동',                           // 구매자 이름
        buyer_tel: '01012341234',                     // 구매자 전화번호
        buyer_email: 'email@email.com',               // 구매자 이메일
        buyer_addr: '신사동 661-16',                    // 구매자 주소
        buyer_postcode: '06018',                      // 구매자 우편번호
    };

    // 1. 임시로 주문 DB 저장

    // 2.


    $.ajax({
        url: '/api/reservations/' + encodedRoomId,
        type: 'POST',
        dataType: 'json',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(reservationParam),
    }).done((result) => {
        console.log('result: ', result);

        IMP.init('imp46152022'); // 가맹점 식별 코드
        IMP.request_pay({
            pg: "kicc.{상점 ID}", // https://developers.portone.io/docs/ko/pg/payment-gateway/kicc
            pay_method: "card",
            merchant_uid: "order_no_0001", // 상점에서 생성한 고유 주문번호
            name: "주문명:결제테스트",
            amount: 1004,
            buyer_email: "test@portone.io",
            buyer_name: "구매자이름",
            buyer_tel: "010-1234-5678", // 필수
            buyer_addr: "서울특별시 강남구 삼성동",
            buyer_postcode: "123-456",
            // m_redirect_url: "{모바일에서 결제 완료 후 리디렉션 될 URL}", // 리디렉션 방식의 경우 callback은 실행되지 않습니다.
        }, function (rsp) {
            if (rsp.success) {
                console.log('rsp: ', rsp);

                const paymentParam = {
                    imp_uid: rsp.imp_uid,
                    amount: price,
                    reservationNo: rsp.merchant_uid
                }

                $.ajax({
                    url: '/api/payments/' + encodedRoomId,
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(paymentParam)
                }).done((data) => {
                    console.log('data: ', data);

                    let msg = '결제가 완료되었습니다.';
                    msg += '\n고유 ID : ' + rsp.imp_uid;
                    msg += '\n숙소 예약 번호 : ' + rsp.merchant_uid;
                    msg += '\n결제 금액 : ' + rsp.paid_amount;
                    msg += '\n카드 승인번호 : ' + rsp.apply_num;

                    alert(msg);
                }).fail((xhr) => {
                    console.log(xhr);
                    alert(xhr.responseJSON.message);
                });
            } else {
                let msg = '결제에 실패하였습니다.';
                msg += '에러내용 : ' + rsp.error_msg;

                alert(msg);
            }
        });
    }).fail((xhr) => {
        console.log(xhr);
        alert(xhr.responseJSON.message);
    });

    function generateReservationNumber() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        let orderNum = year + month + day;

        for (let i = 0; i < 10; i++) {
            orderNum += Math.floor(Math.random() * 8);
        }

        return orderNum;
    }
</script>
</body>
</html>